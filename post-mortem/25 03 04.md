**POST MORTEM:** веб-сервис http://3.69.175.208 – ошибка запуска
**Report executor** (исполнитель отчета): Гута Евгений из команды разработчиков “111124-ptm”
**Date** (дата): 2025-03-04
**Incident** (инцидент):
Веб-сервис ( http://3.69.175.208) перестал работать 4 марта 2025 года в 09:00. Пользователи не могли получить доступ к сайту, возникала критическая ошибка при попытке подключиться по http-адресу.
Reasons for the incident (причины инцидента):
1. Недостаток свободного места на диске из-за файла “access_log”.
2. Неправильный http-адрес в конфигурационном файле настроек “LocalSettings.php”.

**Steps taken to restore** (предпринятые шаги для восстановления):
- при попытке подключения к сервису http://3.69.175.208 , возникла ошибка загрузки сайта. “$wgServer must be set in LocalSettings.php.                                                                                See https://www.mediawiki.org/wiki/Manual:$wgServer”
- получил доступ к серверу ec2-user от администратора, подключился к нему: 
в интерпретаторе Bash, команда: ssh ec2-user@3.69.175.208
- в консоли запустил bash-демона, “httpd”- веб-сервер, который обрабатывает запросы к сайтам, для проверки работоспособности сервера The Apache HTTP Server: 
в Bash, команда: service httpd status
- “…Active(running)…” убедился, что сервер работает – проблема не в запуске
в Bash, команда: sudo systemctl restart http.service   # от имени администратора перезапустил сервис 
в Bash, команда: sudo systemctl status httpd.service  # перепроверил запускается ли сервис после перезапуска , ошибка не пропала. 
- при попытке открыть файл-настроек, для проверки конфигурации подключений:       LocalSettings (5).php , появилась ошибка:  “No space left on device".                                         Возможно проблема с памятью на сервере.
в Bash, команда: free –h # проверил оперативную память, проблем не обнаружил.
в Bash, команда: df –h  # проверил сколько физически свободного дискового пространства на сервере, его практически не осталось. Предполагаю наличие больших файлов на сервере.
в Bash, команда: sudo find / -type f –size +100M | xargs sudo du –h  # с правами администратора, искал большие файлы на сервере и их размер. 
- был обнаружен большой файл access_log (7GB), несущий информацию о работе web сервера, в который он записывает все запросы, которые обрабатывает. Так как для корректной работы сервера необходимо место для записи, например, log-файлов, в этом может быть проблема 
-  файл access_log, возможно, обладает нужной информацией, перенес его для хранения в облачную среду, освободив дисковое пространство.
в Bash, команда: sudo systemctl restart http.service   # проверил, что ошибка исправлена, от имени администратора перезапустил сервис. Ошибка так же появляется.
- при попытке подключения к сервису http://3.69.175.208 , появляется ошибка, указывающая на файл-настроек LocalSettings.php, который находится в директории /var/www/html/mediawiki/
- в домашней директории найден от администратора файл LocalSettings (5).php с настройками приложения . Предполагаю, что можно попробовать заменить “старый” на “новый” файл конфигурации для решения инцидента.
в Bash, команда: mv LocalSettings.php LocalSettings.php.bkp  # убрал “старый” файл-конфигурации в бэкап, для восстановления, если проблема не в этом файле.
в Bash, команда: cp ~/”LocalSettings (5).php” /var/www/html/mediawiki/LocalSettings.php  # скопировал LocalSettings (5).php из домашней директории в папку сервиса и переименовал файл - настройки в LocalSettings.php  
в Bash, команда: ls /var/www/html/mediawiki/   # проверил наличие файла –настроек LocalSettings.php после копировании, в папки сервиса /var/www/html/mediawiki/ . Там же был обнаружен временный файл, созданный ранее после редактора, .LocalSettings.php.swp. Наличие этого файла может вызвать конфликт при открытии в редакторе-файлов LocalSettings.php
в Bash, команда: rm .LocalSettings.php.swp   # удалил файл .LocalSettings.php.swp, чтобы избежать конфликтов 
в Bash, команда: sudo systemctl restart http.service   # от имени администратора перезапустил сервис. Сервис все так же не открывается. 
- при попытке подключения по адресу http://3.69.175.208 , ошибка. Происходит переподключение по адресу http://18.153.51.162 Возможно есть ошибки в файле-конфигурации.
в Bash, команда: vim LocalSettings.php   # в редакторе, открыв “новый” файл-конфигурации, в строке $wgServer мной был обнаружен неправильный URL адрес http://18.153.51.162, по этому неправильному адресу и пытается подключится сервис. 
-	изменил на правильный адрес: $wgServer=”https://3.69.175.208”;
-	проблема решена. Сервис открывается корректно по URL адресу: https://3.69.175.208


**Results** (результаты):
После выполнения всех шагов, веб-сервис был успешно восстановлен, сайт начал работать корректно. Проблема с недостатком места на диске была решена, и файл настроек был успешно скопирован и исправен.

**Recommendations for process improvement** (рекомендации по улучшению процессов)
- создать скрипт backup_logs.sh  для автоматической архивизации логов, удаления старых копий и перезапускает веб-сервер Apache.
в bash:
touch backup_logs.sh
chmod ugo +x backup_logs.sh
vim backup_logs.sh # скрипт в текстовом редакторе 
#!/bin/bash
_# 1. создать переменную даты и архива журнала доступа (access log) в указанной папке с именем, содержащим текущую дату_
DATE=$(date "+%Y%m%d-%M")
tar -czvf /home/ec2-user/access_log_archives/"$DATE"_access_log.tar.gz /var/log/httpd/access_log
_# 2. Очистка файла журнала доступа (добавление пустой строки)_
echo "" > /var/log/httpd/access_log
_# 3. поиск и удаление архивов, которые были изменены  24 часа или больше назад_
find /home/ec2-user/access_log_archives/ -name "*.tar.gz" -mtime +1 | xargs rm
_# 4. перезапуск apache_
sudo systemctl restart httpd.service

-  Создать задачу в планировщике cron, чтобы скрипт backup_logs.sh  выполнялся каждый день.
в bash: sudo vim /etc/crontab
00 *** /home/ec2-user/backup_logs.sh
