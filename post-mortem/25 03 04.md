**POST MORTEM:** веб-сервис http://3.69.175.208 – ошибка запуска

**Report executor** (исполнитель отчета): Гута Евгений из команды разработчиков “111124-ptm”

**Date** (дата): 2025-03-04

**Incident** (инцидент):

Веб-сервис ( http://3.69.175.208) перестал работать 4 марта 2025 года в 09:00. Пользователи не могли получить доступ к сайту, возникала критическая ошибка при попытке подключиться по http-адресу.
Reasons for the incident (причины инцидента):
1. Недостаток свободного места на диске из-за файла “access_log”.
2. Неправильный http-адрес в конфигурационном файле настроек “LocalSettings.php”.

**Steps taken to restore** (предпринятые шаги для восстановления):

1. при попытке подключения к сервису http://3.69.175.208 , возникла ошибка загрузки сайта.
  “$wgServer must be set in LocalSettings.php.                                                                                
   See https://www.mediawiki.org/wiki/Manual:$wgServer”
   
2. получил доступ к серверу ec2-user от администратора, подключился к нему: 
   ```ssh ec2-user@3.69.175.208```
   
3. в консоли запустил bash-демона, “httpd”- веб-сервер, который обрабатывает запросы к сайтам, для проверки работоспособности 
   сервера The Apache HTTP Server: 
   ```service httpd status```
   
4. “…Active(running)…” убедился, что сервер работает – проблема не в запуске
   
   ```sudo systemctl restart http.service```   # от имени администратора перезапустил сервис 
   ```sudo systemctl status httpd.service```  # перепроверил запускается ли сервис после перезапуска , ошибка не пропала.
   
5. при попытке открыть файл-настроек, для проверки конфигурации подключений: LocalSettings (5).php ,
   появилась ошибка:  “No space left on device". Возможно проблема с памятью на сервере.
   
6. ```free –h``` # проверил оперативную память, проблем не обнаружил.
   
7.  ```df –h```  # проверил сколько физически свободного дискового пространства на сервере, его практически не осталось. 
   Предполагаю наличие больших файлов на сервере.

8. ```sudo find / -type f –size +100M | xargs sudo du –h```  # с правами администратора, искал большие файлы на сервере и их 
   размер.
   
9. был обнаружен большой файл access_log (7GB), несущий информацию о работе web сервера, в который он записывает все запросы, 
   которые обрабатывает. Так как для корректной работы сервера необходимо место для записи, например, log-файлов, в этом 
   может быть проблема

10. файл access_log, возможно, обладает нужной информацией, перенес его для хранения в облачную среду, освободив дисковое 
    пространство.

11. ```sudo systemctl restart http.service```   # проверил, что ошибка исправлена, от имени администратора перезапустил 
    сервис. Ошибка так же появляется.

12. при попытке подключения к сервису http://3.69.175.208 , появляется ошибка, указывающая на файл-настроек 
    LocalSettings.php, который находится в директории /var/www/html/mediawiki/

13. в домашней директории найден от администратора файл LocalSettings (5).php с настройками приложения . Предполагаю, что 
    можно попробовать заменить “старый” на “новый” файл конфигурации для решения инцидента.

14. ```mv LocalSettings.php LocalSettings.php.bkp```  # убрал “старый” файл-конфигурации в бэкап, для восстановления, если 
    проблема не в этом файле.

15. ```cp ~/”LocalSettings (5).php” /var/www/html/mediawiki/LocalSettings.php```  # скопировал LocalSettings (5).php из 
    домашней директории в папку сервиса и переименовал файл - настройки в LocalSettings.php

16. ```ls /var/www/html/mediawiki/```   # проверил наличие файла –настроек LocalSettings.php после копировании, в папки 
    сервиса /var/www/html/mediawiki/ . Там же был обнаружен временный файл, созданный ранее после редактора, 
    .LocalSettings.php.swp. Наличие этого файла может вызвать конфликт при открытии в редакторе-файлов LocalSettings.php

17. ```rm .LocalSettings.php.swp```   # удалил файл .LocalSettings.php.swp, чтобы избежать конфликтов

18. ```sudo systemctl restart http.service```   # от имени администратора перезапустил сервис. Сервис все так же не 
    открывается.

19. при попытке подключения по адресу http://3.69.175.208 , ошибка. Происходит переподключение по адресу     
    http://18.153.51.162 Возможно есть ошибки в файле-конфигурации.

20. ```vim LocalSettings.php```   # в редакторе, открыв “новый” файл-конфигурации, в строке $wgServer мной был обнаружен 
    неправильный URL адрес http://18.153.51.162, по этому неправильному адресу и пытается подключится сервис.

21. изменил на правильный адрес: $wgServer=”https://3.69.175.208”;
    Проблема решена. Сервис открывается корректно по URL адресу: https://3.69.175.208


**Results** (результаты):

После выполнения всех шагов, веб-сервис был успешно восстановлен, сайт начал работать корректно. Проблема с недостатком места на диске была решена, и файл настроек был успешно скопирован и исправен.

**Recommendations for process improvement** (рекомендации по улучшению процессов)

1. создать скрипт backup_logs.sh  для автоматической архивизации логов, удаления старых копий и перезапускает веб-сервер Apache.

2. bash:
   ```touch backup_logs.sh```
   ```chmod ugo +x backup_logs.sh```
   ```vim backup_logs.sh``` # скрипт в текстовом редакторе
   
   #!/bin/bash
   _# 1. создать переменную даты и архива журнала доступа (access log) в указанной папке с именем, содержащим текущую дату_
   DATE=$(date "+%Y%m%d-%M")
   tar -czvf /home/ec2-user/access_log_archives/"$DATE"_access_log.tar.gz /var/log/httpd/access_log
   _# 2. Очистка файла журнала доступа (добавление пустой строки)_
   echo "" > /var/log/httpd/access_log
   _# 3. поиск и удаление архивов, которые были изменены  24 часа или больше назад_
   find /home/ec2-user/access_log_archives/ -name "*.tar.gz" -mtime +1 | xargs rm
   _# 4. перезапуск apache_
   sudo systemctl restart httpd.service

3. Создать задачу в планировщике cron, чтобы скрипт backup_logs.sh  выполнялся каждый день.
   в bash:
   ```sudo vim /etc/crontab```
   00 *** /home/ec2-user/backup_logs.sh
